# Install prerequisites
sudo apt-get -y update
sudo apt-get -y dist-upgrade

# Install Icecast
sudo apt-get -yq install icecast2 wget
wget http://sourceforge.net/projects/darkice/files/darkice/1.3/darkice-1.3.tar.gz

# Install ices
sudo apt-get install -yq ices2

# Create streaming user
sudo useradd icecast -g audio

# Set correct permissions
sudo mkdir -p /var/log/icecast2
sudo mkdir -p /var/log/ices

sudo chown -R icecast /var/log/icecast2
sudo chown -R icecast /var/log/ices

# Icecast systemd integration
cat <<EOT | sudo tee /etc/default/icecast2
# Full path to the server configuration file
CONFIGFILE="/etc/icecast2/icecast.xml"

# Name or ID of the user and group the daemon should run under
USERID=icecast
GROUPID=audio
ENABLE=true
EOT
sudo systemctl enable icecast2

# Install config files
cd /etc
sudo mv ices.xml ices.xml.bak
sudo wget https://raw.githubusercontent.com/hifiberry/hifiberry-tools/master/conf/ices.conf
sudo mv ices.conf ices.xml
sudo chown icecast ices.xml
cd /etc/icecast2
sudo mv icecast.xml icecast.xml.bak
sudo wget https://raw.githubusercontent.com/hifiberry/hifiberry-tools/master/conf/icecast.xml
sudo chown icecast icecast.xml
